<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Somnia Christmas Quest: Web3 Arcade</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- General Theme & Fonts --- */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&family=Mountains+of+Christmas:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d3625; /* Deep Festive Green */
            color: #ffffff;
            min-height: 100vh;
            position: relative;
            overflow: hidden; 
        }
        
        /* --- Snow Effect --- */
        .snow {
            position: absolute;
            top: -10px;
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            opacity: 0.8;
            z-index: 100; /* Ensure snow is above all content */
            filter: blur(0.5px); /* Added blur for softer look */
            animation: snowFall linear infinite;
        }
        @keyframes snowFall {
            from { transform: translateY(0); }
            to { transform: translateY(120vh); }
        }

        /* --- Layout & Components --- */
        #container {
            display: flex;
            height: 100vh;
            width: 100vw;
            position: relative;
            z-index: 10; /* Above snow */
        }
        .sidebar {
            width: 200px;
            min-width: 200px;
            background-color: #0a2d1f; 
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.6);
            display: flex;
            flex-direction: column;
            padding: 1rem;
        }
        .main-content {
            flex-grow: 1;
            padding: 2rem;
            background-color: #123e2d; 
            overflow-y: auto;
        }
        
        .nav-btn {
            @apply flex items-center p-3 w-full rounded-xl text-left transition duration-200 ease-in-out font-semibold text-lg hover:bg-red-700 hover:shadow-lg;
            color: #ffffff;
            background-color: #8c2727; /* Deep Red Button */
            margin-top: 0.75rem;
        }
        .nav-btn.active {
            @apply bg-red-600 shadow-xl border-l-4 border-yellow-300;
        }
        .nav-btn svg {
            @apply mr-3;
        }

        /* Candy Cane Border for Game */
        .game-canvas-area {
            height: 60vh;
            max-height: 600px; /* Batasi tinggi untuk tampilan yang lebih baik */
            background-color: #000000;
            border: 5px solid #ff0000; 
            border-image: linear-gradient(45deg, #ff0000 25%, #ffffff 25%, #ffffff 50%, #ff0000 50%, #ff0000 75%, #ffffff 75%); 
            border-image-slice: 1;
            border-image-width: 15px;
            box-shadow: 0 0 35px rgba(255, 69, 0, 0.9);
            animation: pulse-shadow 2s infinite alternate;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* Canvas Styling */
        #pacmanCanvas {
            background-color: #0d3625; /* Warna labirin */
            display: block;
            border-radius: 8px;
        }

        @keyframes pulse-shadow {
            from { box-shadow: 0 0 30px rgba(255, 69, 0, 0.7); }
            to { box-shadow: 0 0 40px rgba(255, 255, 0, 0.9); }
        }
    </style>
    <!-- Load Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            onSnapshot, 
            collection, 
            query, 
            limit, 
            orderBy,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firestore log level to Debug
        setLogLevel('Debug');

        // Global variables from the Canvas environment (MUST BE USED)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'somnia-christmas-quest';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let currentUserId = null;
        let currentDisplayName = "Gingerbread Fan";
        let isAuthReady = false;
        let isDbReady = false;
        let currentView = 'preview'; 
        
        // --- WEB3 SIMULATION STATE ---
        let isWalletConnected = false;
        let somiBalance = 0.00;
        let hasPaidForGame = false;
        let gameActive = false;
        let currentScore = 0;
        const COST_TO_PLAY = 0.01; // ETH cost

        // --- GAME STATE VARIABLES (NEW) ---
        let canvas, ctx;
        let tileSize = 20;
        let player = { x: 1, y: 1, dx: 0, dy: 0, radius: 8, color: 'yellow', angle: 0, mouthOpen: 0 };
        let gameLoopId = null;
        let pelletsRemaining = 0;
        
        // 0: Wall, 1: Path/Pellet, 2: Empty Path
        const originalMap = [
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
            [0,1,1,1,1,1,1,1,1,0,0,1,1,1,1,1,1,1,1,0],
            [0,1,0,0,1,0,0,0,1,0,0,1,0,0,0,1,0,0,1,0],
            [0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
            [0,1,0,0,1,0,1,0,0,0,0,0,0,1,0,1,0,0,1,0],
            [0,1,1,1,1,0,1,1,1,1,1,1,1,1,0,1,1,1,1,0],
            [0,0,0,0,1,0,0,0,1,0,0,1,0,0,0,1,0,0,0,0],
            [0,0,0,0,1,0,1,1,1,0,0,1,1,1,0,1,0,0,0,0],
            [0,0,0,0,1,0,1,0,0,0,0,0,0,1,0,1,0,0,0,0],
            [0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
            [0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,1,0,0,1,0],
            [0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
        ];
        let map; // Map working copy

        // --- UTILITY FUNCTIONS (Modal) ---
        function showMessageModal(title, message, isError = false) {
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const modalContainer = document.getElementById('messageModal');

            modalTitle.textContent = title;
            modalBody.innerHTML = message;
            
            const card = modalContainer.querySelector('.modal-card');
            card.classList.toggle('border-red-500', isError);
            card.classList.toggle('border-green-500', !isError);

            modalContainer.classList.remove('hidden');
        }

        function hideMessageModal() {
            document.getElementById('messageModal').classList.add('hidden');
        }
        window.hideMessageModal = hideMessageModal;

        // --- VIEW MANAGEMENT ---
        function renderView(viewName) {
            currentView = viewName;
            
            ['preview', 'game', 'leaderboard'].forEach(view => {
                const el = document.getElementById(view + 'View');
                if (el) {
                    el.classList.toggle('hidden', view !== viewName);
                }
            });

            ['connectWalletBtn', 'playGameBtn', 'leaderboardBtn'].forEach(id => {
                const btn = document.getElementById(id);
                if (btn) {
                    btn.classList.remove('active');
                }
            });

            if (viewName === 'game') {
                document.getElementById('playGameBtn').classList.add('active');
                resetGameDisplay();
            } else if (viewName === 'leaderboard') {
                document.getElementById('leaderboardBtn').classList.add('active');
                if (isDbReady) fetchLeaderboard();
            } else if (viewName === 'preview') {
                document.getElementById('playGameBtn').classList.remove('active');
                document.getElementById('leaderboardBtn').classList.remove('active');
            }
        }
        window.renderView = renderView;

        // --- FIREBASE INITIALIZATION & AUTHENTICATION ---
        async function initApp() {
            try {
                if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
                    throw new Error("Firebase configuration not found.");
                }
                
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                    } else {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                    isAuthReady = true;
                    isDbReady = true;
                    updateUIState();
                    // Load the default preview view after auth
                    renderView('preview'); 
                });

                document.getElementById('criticalError').classList.add('hidden');
            } catch (error) {
                console.error("[CRITICAL ERROR] Failed to initialize Firebase:", error);
                document.getElementById('criticalError').classList.remove('hidden');
                document.getElementById('criticalError').textContent = `[CRITICAL ERROR] Initialization failed: ${error.message}`;
            }
        }

        // --- WEB3 SIMULATION LOGIC ---
        function connectWallet() {
            // This simulates MetaMask connection success
            if (isWalletConnected) {
                showMessageModal("Info", `Wallet is already connected. SOMI Balance: ${somiBalance.toFixed(2)}.`);
                return;
            }

            isWalletConnected = true;
            somiBalance = (Math.random() * 100 + 10).toFixed(2); // Ensure positive balance for display
            showMessageModal("Connection Successful!", `Wallet connected. Your SOMI Balance: ${somiBalance} SOMI.`);
            updateUIState();
        }
        window.connectWallet = connectWallet;

        async function payToPlay() {
            if (!isWalletConnected) {
                showMessageModal("Attention", "Please connect your Wallet first.", true);
                return;
            }
            
            // Simulation of contract call for 0.01 ETH
            document.getElementById('payToPlayBtn').textContent = "Transaction in progress...";
            document.getElementById('payToPlayBtn').disabled = true;

            await new Promise(resolve => setTimeout(resolve, 2000)); 
            
            // Simulate transaction success
            hasPaidForGame = true;
            startGame();
            
            showMessageModal("Payment Successful!", `${COST_TO_PLAY} ETH has been paid. Game Controls are now activated!`);
            updateUIState();
        }
        window.payToPlay = payToPlay;

        // --- GAME LOGIC (Implementation) ---
        function initializeCanvas() {
            canvas = document.getElementById('pacmanCanvas');
            if (!canvas) return;
            ctx = canvas.getContext('2d');
            
            // Set canvas size dynamically based on map size
            canvas.width = originalMap[0].length * tileSize;
            canvas.height = originalMap.length * tileSize;
            
            // Setup keyboard listeners
            document.removeEventListener('keydown', handleKeyDown);
            document.addEventListener('keydown', handleKeyDown);
            
            // Setup touch/swipe listeners for mobile
            setupTouchControls();
        }

        function setupTouchControls() {
            let startX, startY;

            canvas.addEventListener('touchstart', (e) => {
                if (!gameActive) return;
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
            });

            canvas.addEventListener('touchend', (e) => {
                if (!gameActive || !startX) return;
                const endX = e.changedTouches[0].clientX;
                const endY = e.changedTouches[0].clientY;

                const dx = endX - startX;
                const dy = endY - startY;

                // Determine swipe direction
                if (Math.abs(dx) > Math.abs(dy)) {
                    // Horizontal swipe
                    player.dx = dx > 0 ? 1 : -1;
                    player.dy = 0;
                } else {
                    // Vertical swipe
                    player.dy = dy > 0 ? 1 : -1;
                    player.dx = 0;
                }
                startX = startY = null; // Reset
            });
        }
        
        function handleKeyDown(e) {
            if (!gameActive) return;
            let newDx = 0, newDy = 0;
            switch(e.key) {
                case 'ArrowUp':
                case 'w':
                    newDy = -1; break;
                case 'ArrowDown':
                case 's':
                    newDy = 1; break;
                case 'ArrowLeft':
                case 'a':
                    newDx = -1; break;
                case 'ArrowRight':
                case 'd':
                    newDx = 1; break;
                default: return;
            }
            e.preventDefault(); 
            
            // Set direction only if it's not blocked by a wall immediately
            if (map[player.y + newDy] && map[player.y + newDy][player.x + newDx] !== 0) {
                player.dx = newDx;
                player.dy = newDy;
            }
        }

        function drawMap() {
            for (let y = 0; y < map.length; y++) {
                for (let x = 0; x < map[y].length; x++) {
                    const center = { x: x * tileSize + tileSize / 2, y: y * tileSize + tileSize / 2 };
                    
                    if (map[y][x] === 0) {
                        // Wall (Christmas Themed)
                        ctx.fillStyle = '#ff0000'; // Red Wall
                        ctx.fillRect(x * tileSize, y * tileSize, tileSize, tileSize);
                        ctx.strokeStyle = '#ffffff'; // White line for candy cane look
                        ctx.strokeRect(x * tileSize, y * tileSize, tileSize, tileSize);
                    } else if (map[y][x] === 1) {
                        // Pellet (Christmas Dot)
                        ctx.fillStyle = '#00ffae'; // Bright Green/Aqua Pellet
                        ctx.beginPath();
                        ctx.arc(center.x, center.y, 3, 0, 2 * Math.PI);
                        ctx.fill();
                    }
                }
            }
        }
        
        function drawPlayer() {
            const centerX = player.x * tileSize + tileSize / 2;
            const centerY = player.y * tileSize + tileSize / 2;
            
            // Adjust mouth open/close for animation
            player.mouthOpen = Math.cos(Date.now() / 100) * 0.15 + 0.15;

            // Determine angle for drawing (based on direction)
            if (player.dx === 1) player.angle = 0;
            else if (player.dx === -1) player.angle = Math.PI;
            else if (player.dy === -1) player.angle = -Math.PI / 2;
            else if (player.dy === 1) player.angle = Math.PI / 2;

            ctx.fillStyle = player.color;
            ctx.beginPath();
            ctx.arc(
                centerX, 
                centerY, 
                player.radius, 
                player.angle + player.mouthOpen, 
                player.angle + 2 * Math.PI - player.mouthOpen
            );
            ctx.lineTo(centerX, centerY);
            ctx.fill();
        }

        function updateGame() {
            if (!gameActive) return;

            // Player movement
            const nextX = player.x + player.dx;
            const nextY = player.y + player.dy;

            if (map[nextY] && map[nextY][nextX] !== 0) {
                player.x = nextX;
                player.y = nextY;
            } else {
                // Stop player if hitting a wall in the current direction
                // Prevents sliding along walls
                player.dx = 0;
                player.dy = 0;
            }

            // Pellet collection
            if (map[player.y][player.x] === 1) {
                map[player.y][player.x] = 2; // Mark as collected
                currentScore += 10; // Score per pellet
                pelletsRemaining--;
                document.getElementById('gameScoreDisplay').textContent = currentScore.toLocaleString();
            }

            // Win condition (All pellets collected)
            if (pelletsRemaining === 0) {
                endGame(true);
                return;
            }

            // Simple Ghost logic (No ghosts in this minimal version, focusing on core Pac-Man)

            // Redraw everything
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawMap();
            drawPlayer();

            // Loop the game
            gameLoopId = requestAnimationFrame(updateGame);
        }

        function resetGameDisplay() {
            // Ensure canvas is initialized when view is set to game
            if (!canvas) initializeCanvas(); 
            
            gameActive = false;
            currentScore = 0;
            document.getElementById('gameStatus').textContent = 'Ready to Play.';
            document.getElementById('gameScoreDisplay').textContent = '0';
            
            const payBtn = document.getElementById('payToPlayBtn');
            payBtn.textContent = `Pay ${COST_TO_PLAY} ETH to Start`;
            payBtn.disabled = !isWalletConnected;
            
            document.getElementById('gameOverControls').classList.add('hidden');
            
            // Reset map
            map = originalMap.map(row => [...row]);
            
            // Count total pellets and reset player position
            pelletsRemaining = map.flat().filter(tile => tile === 1).length;
            player.x = 1;
            player.y = 1;
            player.dx = 0;
            player.dy = 0;
            
            if (!hasPaidForGame) {
                document.getElementById('payToPlayContainer').classList.remove('hidden');
                document.getElementById('gameStatus').textContent = 'Controls Disabled (Pay to Play).';
            } else {
                document.getElementById('payToPlayContainer').classList.add('hidden');
                // Auto start if paid
                startGame();
            }
            
            // Draw initial state
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawMap();
            drawPlayer();

            updateUIState();
        }
        
        function startGame() {
            if (!hasPaidForGame || gameActive) return;
            
            gameActive = true;
            document.getElementById('gameStatus').textContent = 'Game Running! (Use Arrow Keys / Swipe)';
            document.getElementById('payToPlayContainer').classList.add('hidden');
            document.getElementById('gameOverControls').classList.add('hidden');
            
            // Start the actual game loop
            updateGame(); 
        }
        
        function endGame(won = false) {
            if (gameLoopId) cancelAnimationFrame(gameLoopId);
            gameActive = false;
            
            if (won) {
                document.getElementById('gameStatus').textContent = 'YOU WON! Score: ' + currentScore.toLocaleString();
            } else {
                document.getElementById('gameStatus').textContent = 'GAME OVER!';
            }
            
            document.getElementById('gameOverControls').classList.remove('hidden');
            
            // Auto submit score
            submitScoreToContract(currentScore);
        }

        async function submitScoreToContract(score) {
            if (!isWalletConnected || !currentUserId || score <= 0) {
                showMessageModal("Submit Failed", "Invalid score or Wallet not connected.", true);
                return;
            }
            
            showMessageModal("Submitting Score", `Your final score of ${score.toLocaleString()} is being recorded to the Leaderboard...`);

            // --- SIMULATE SMART CONTRACT/API INTERACTION (2 seconds) ---
            await new Promise(resolve => setTimeout(resolve, 2000)); 
            
            // Record score to Firestore Leaderboard (Persistence)
            if (isDbReady) {
                saveToFirestoreLeaderboard(score);
            }

            showMessageModal("Score Successfully Recorded!", `Score ${score.toLocaleString()} has been added to the official Leaderboard.`);
            
            // Reset game status and show leaderboard
            hasPaidForGame = false; 
            renderView('leaderboard'); 
        }
        
        async function saveToFirestoreLeaderboard(score) {
            try {
                // Public data path: /artifacts/{appId}/public/data/leaderboard/{userId}
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'leaderboard', currentUserId);
                
                await setDoc(docRef, {
                    userId: currentUserId,
                    displayName: currentDisplayName,
                    score: score,
                    timestamp: serverTimestamp() 
                }, { merge: true }); 

            } catch (error) {
                console.error("Failed to record score to Firestore:", error);
            }
        }

        // --- LEADERBOARD LOGIC (Unchanged) ---
        let unsubscribeLeaderboard = null;

        function fetchLeaderboard() {
            if (!isDbReady) return;

            if (unsubscribeLeaderboard) {
                unsubscribeLeaderboard(); 
            }
            
            const leaderboardCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard');
            const q = query(
                leaderboardCollectionRef, 
                limit(100) 
            );

            document.getElementById('leaderboardList').innerHTML = '<p class="text-center text-yellow-300">Loading festive scores...</p>';
            
            unsubscribeLeaderboard = onSnapshot(q, (snapshot) => {
                const leaderboard = [];
                snapshot.forEach((doc) => {
                    leaderboard.push({ ...doc.data(), id: doc.id });
                });
                
                // Sort in memory by score (descending)
                leaderboard.sort((a, b) => b.score - a.score);

                renderLeaderboard(leaderboard.slice(0, 10)); // Show only top 10
            }, (error) => {
                console.error("Failed to fetch Leaderboard:", error);
                document.getElementById('leaderboardList').innerHTML = `<p class="text-center text-red-400">Failed to load Leaderboard: ${error.message}</p>`;
            });
        }

        function renderLeaderboard(data) {
            const listEl = document.getElementById('leaderboardList');
            if (data.length === 0) {
                listEl.innerHTML = '<p class="text-center text-gray-400 mt-4">No scores recorded yet. Be the first!</p>';
                return;
            }
            
            const html = `
                <table class="min-w-full divide-y divide-gray-700 rounded-xl overflow-hidden">
                    <thead class="bg-red-900">
                        <tr class="text-left text-sm font-semibold text-white">
                            <th class="px-4 py-3">#</th>
                            <th class="px-4 py-3">Player ID</th>
                            <th class="px-4 py-3 text-right">High Score</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-red-900/50">
                        ${data.map((entry, index) => `
                            <tr class="${entry.userId === currentUserId ? 'bg-yellow-800 bg-opacity-30 font-bold' : 'hover:bg-red-900'} text-gray-200">
                                <td class="px-4 py-3 whitespace-nowrap text-sm">${index + 1}</td>
                                <td class="px-4 py-3 text-sm">
                                    <span class="text-white">${entry.displayName || 'Anonim'}</span> 
                                    <span class="text-xs text-gray-500 block">${entry.userId}</span>
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-right text-yellow-300 font-extrabold">${entry.score.toLocaleString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            listEl.innerHTML = html;
        }

        // --- UI STATE UPDATE GLOBAL ---
        function updateUIState() {
            // Sidebar: Wallet Status
            const walletStatusEl = document.getElementById('walletStatus');
            const connectBtn = document.getElementById('connectWalletBtn');
            
            if (isWalletConnected) {
                walletStatusEl.innerHTML = `<span class="text-green-400 font-bold">Connected</span> | ${somiBalance} $SOMI`;
                connectBtn.classList.add('active');
            } else {
                walletStatusEl.innerHTML = `<span class="text-red-400">Disconnected</span> | 0 $SOMI`;
                connectBtn.classList.remove('active');
            }
            
            // Sidebar: User ID
            const userIdEl = document.getElementById('currentUserIdDisplay');
            if (userIdEl) {
                 userIdEl.textContent = `User ID: ${currentUserId || 'N/A'}`;
            }

            // Game View: Pay Button State
            const payBtn = document.getElementById('payToPlayBtn');
            if (payBtn) {
                payBtn.disabled = !isWalletConnected;
            }
        }

        // Run app initialization when the window loads
        window.onload = initApp;

    </script>
</head>
<body class="antialiased">

    <!-- SNOW EFFECT INTEGRATION - DENSITY INCREASED -->
    <script>
        for(let i=0;i<100;i++){ 
            const snow=document.createElement("div");
            snow.className="snow";
            snow.style.left=Math.random()*100+"vw";
            snow.style.animationDuration=(Math.random()*5+5)+"s";
            snow.style.animationDelay=(Math.random()*5)+"s";
            snow.style.width = snow.style.height = (Math.random() * 5 + 3) + "px"; 
            snow.style.opacity=Math.random() * 0.8 + 0.4; 
            document.body.appendChild(snow);
        }
    </script>
    <!-- END SNOW EFFECT -->

    <!-- CRITICAL ERROR BANNER -->
    <div id="criticalError" class="hidden fixed top-0 left-0 right-0 p-3 bg-red-700 text-white text-center font-bold z-50">
        [CRITICAL ERROR] Failed to connect to Firebase services.
    </div>
    
    <div id="container">
        <!-- === LEFT SIDEBAR (FIXED) === -->
        <nav class="sidebar z-20">
            
            <!-- App Title / Logo -->
            <div class="p-2 border-b-2 border-yellow-300 mb-4">
                <h1 class="text-2xl font-extrabold text-red-500 font-[Mountains of Christmas]">
                    SOMNIA QUEST
                </h1>
                <p class="text-xs text-gray-400 mt-1" id="currentUserIdDisplay">User ID: Loading...</p>
            </div>

            <!-- Wallet Status -->
            <button id="connectWalletBtn" onclick="connectWallet()" class="nav-btn bg-green-800 hover:bg-green-700">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12V7H3v10a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-5M7 12h4m-4 0v-4m12-5v.01"/></svg>
                Connect Wallet
            </button>
            <div id="walletStatus" class="text-xs text-gray-300 text-center mb-4">Disconnected | 0 $SOMI</div>
            
            <hr class="border-red-600 my-4">

            <!-- Navigation Buttons -->
            <button id="playGameBtn" onclick="renderView('game')" class="nav-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                Play Game
            </button>
            
            <button id="leaderboardBtn" onclick="renderView('leaderboard')" class="nav-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20V10M18 20V4M6 20v-4"></path></svg>
                Leaderboard
            </button>

            <!-- Footer -->
            <footer class="mt-auto pt-4 text-xs text-red-300 text-center border-t border-red-600/50">
                Created by: @ifunkkalem
            </footer>
        </nav>
        
        <!-- === RIGHT MAIN CONTENT (DYNAMIC) === -->
        <main class="main-content">
            
            <h2 class="text-5xl font-black mb-6 text-yellow-300 font-[Mountains of Christmas] text-center">
                üéÑ SOMNIA CHRISTMAS CARNIVAL üéÅ
            </h2>

            <!-- 1. DEFAULT/PREVIEW VIEW -->
            <div id="previewView" class="view-section">
                <div class="bg-red-800 bg-opacity-70 p-8 rounded-2xl shadow-xl border border-yellow-300">
                    <div class="flex flex-col md:flex-row items-center">
                        <div class="md:w-1/2">
                            <h3 class="text-3xl font-extrabold text-white mb-4">
                                Welcome, Christmas Voyager!
                            </h3>
                            <p class="text-gray-200 mb-4">
                                This festive Pac-Man edition lets you compete and record your high score to the Leaderboard by paying a small fee of **0.01 ETH** per session.
                            </p>
                            <p class="font-bold text-yellow-300">
                                Connect your wallet to begin your Christmas Quest!
                            </p>
                        </div>
                        <div class="md:w-1/2 flex justify-center mt-6 md:mt-0">
                            <!-- Christmas Pac-Man SVG Icon -->
                            <svg class="w-28 h-28 text-yellow-300 animate-pulse" viewBox="0 0 100 100" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                <path d="M50 0 A50 50 0 0 1 85.355 14.645 L50 50 Z M50 0 A50 50 0 0 0 14.645 14.645 L50 50 Z" fill="currentColor"/>
                                <circle cx="50" cy="50" r="50" fill="currentColor" mask="url(#pacmask)" />
                                <path d="M50 50 L 78.88 78.88 L 50 50 L 78.88 21.12 L 50 50 Z" fill="#123e2d" transform="rotate(270 50 50)"/>
                                <polygon points="50,15 70,35 75,30 65,5" fill="#FF0000" stroke="#FFFFFF" stroke-width="2"/>
                                <circle cx="65" cy="5" r="4" fill="#FFFFFF"/>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. GAME VIEW -->
            <div id="gameView" class="view-section hidden">
                <h3 class="text-3xl font-bold text-white mb-4">Christmas Quest Game Zone</h3>

                <!-- Game Canvas Area -->
                <div class="game-canvas-area w-full flex items-center justify-center rounded-xl relative">
                    <!-- HTML Canvas element for the game -->
                    <canvas id="pacmanCanvas" class="w-full h-full"></canvas>

                    <!-- Overlay Pay to Play -->
                    <div id="payToPlayContainer" class="absolute inset-0 bg-black bg-opacity-80 flex flex-col items-center justify-center space-y-6 rounded-xl">
                        <p class="text-2xl font-bold text-red-400">PAY TO ACTIVATE CONTROLS</p>
                        <p class="text-lg text-gray-300">Pay <span class="text-yellow-400 font-bold">${COST_TO_PLAY} ETH</span> to begin your session.</p>
                        <button id="payToPlayBtn" onclick="payToPlay()" class="bg-green-600 hover:bg-green-700 text-white font-extrabold py-3 px-8 rounded-full shadow-lg transition duration-300 disabled:opacity-50">
                            Pay ${COST_TO_PLAY} ETH to Start
                        </button>
                    </div>
                    
                    <!-- Game Content Placeholder (Used for instructions/messages) -->
                    <div id="gameMessage" class="absolute inset-0 flex items-center justify-center pointer-events-none">
                        <div class="text-center">
                            <p class="text-5xl font-extrabold text-white mb-4 hidden">PAC-MAN CHRISTMAS</p>
                            <p id="gameStatus" class="text-xl text-yellow-400 font-bold p-2 bg-black bg-opacity-50 rounded">Ready to Play.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Game Info & Controls -->
                <div class="flex justify-between items-center bg-gray-800 p-4 mt-4 rounded-xl shadow-inner border border-red-600">
                    <div>
                        <p class="text-lg font-semibold text-gray-400">Current Score:</p>
                        <p id="gameScoreDisplay" class="text-4xl font-extrabold text-green-400">0</p>
                    </div>
                    <div id="gameOverControls" class="hidden">
                        <button onclick="resetGameDisplay()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">
                            Play Again
                        </button>
                    </div>
                </div>
            </div>

            <!-- 3. LEADERBOARD VIEW -->
            <div id="leaderboardView" class="view-section hidden">
                <h3 class="text-3xl font-bold text-white mb-4">Top 10 Leaderboard (Real-time)</h3>
                
                <div id="leaderboardList" class="bg-gray-900 p-4 rounded-xl shadow-lg border border-red-600">
                    <p class="text-center text-gray-400">Loading data...</p>
                </div>
            </div>

        </main>
    </div>

    <!-- MESSAGE MODAL (Custom Alert Box) -->
    <div id="messageModal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div class="modal-card bg-white p-6 rounded-2xl w-full max-w-sm border-4 border-green-500 shadow-2xl">
            <h3 id="modalTitle" class="text-2xl font-bold mb-3 text-gray-900">Title</h3>
            <p id="modalBody" class="text-gray-700 mb-6"></p>
            <button onclick="hideMessageModal()" class="w-full py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-xl transition duration-150">
                CLOSE
            </button>
        </div>
    </div>

</body>
</html>
