<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Somnia Leaderboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900;800;300&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body {
            background: radial-gradient(circle at top, #2b0033, #0a0010); color: #fff; display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding: 20px 10px;
        }
        h1 {
            font-size: clamp(28px, 6vw, 40px); color: #c77dff; text-shadow: 0 0 10px #800080; margin-bottom: 5px;
        }
        h2 {
            font-size: clamp(16px, 3vw, 20px); color: #ff8c00; margin-bottom: 20px; text-align: center;
        }
        .leaderboard-container {
            width: 100%; max-width: 800px; /* Lebar diperluas untuk alamat wallet */
            background: rgba(20, 0, 30, 0.8); border: 2px solid #ff8c00; border-radius: 16px; padding: 20px; box-shadow: 0 0 15px #800080;
        }
        table {
            width: 100%; border-collapse: collapse; margin-top: 15px;
        }
        th, td {
            padding: 12px 8px; text-align: left; border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        th {
            background-color: rgba(255, 140, 0, 0.2); color: #ff8c00; text-transform: uppercase; font-size: 0.8em;
        }
        td { font-weight: bold; }
        .rank-1 { color: gold; font-size: 1.1em; }
        .rank-2 { color: silver; }
        .rank-3 { color: #cd7f32; }
        .wallet-cell { font-size: 0.7em; word-break: break-all; }
        
        .db-status {
            text-align: center; padding: 10px; margin-bottom: 15px; border-radius: 8px; font-weight: bold;
            background-color: rgba(46, 204, 113, 0.2); color: #2ecc71;
        }
        .action-button {
            width: 100%; padding: 12px; margin-top: 20px; font-size: 1em; font-weight: bold; border: none; border-radius: 10px; cursor: pointer; background: linear-gradient(90deg, #c0392b, #e74c3c); color: white; transition: 0.2s;
        }
        .action-button:hover { box-shadow: 0 0 10px #e74c3c; transform: scale(1.01); }
    </style>
</head>
<body>

<div class="leaderboard-container">
    <h1>SOMNIA LEADERBOARD</h1>
    <h2>Total Skor Akumulatif (Lifetime Points)</h2>
    
    <div id="globalStatus" class="db-status">Memuat Status Database...</div>

    <table>
        <thead>
            <tr>
                <th>Peringkat</th>
                <th>Nama Pemain</th>
                <th>Total Skor Akumulatif</th>
                <th>Alamat Wallet (Identitas Publik)</th>
            </tr>
        </thead>
        <tbody id="leaderboardBody">
            <!-- Data skor akan diisi di sini -->
            <tr><td colspan="4" style="text-align: center;">Memuat data skor...</td></tr>
        </tbody>
    </table>

    <button class="action-button" onclick="window.location.href='index.html'">KEMBALI KE MENU</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, query, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    setLogLevel('Debug');
    
    // Konfigurasi Firebase (NO FALLBACK)
    const appId = typeof __app_id !== 'undefined' ? __app_id : null;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    const rawFirebaseConfig = typeof __firebase_config !== 'undefined' ? __firebase_config : null;

    let db = null;
    let auth = null;
    const leaderboardBody = document.getElementById('leaderboardBody');
    const globalStatusEl = document.getElementById('globalStatus');

    // ====================================================================
    // --- DATA LOADING & AGGREGATION LOGIC (Hanya Wallet) ---
    // ====================================================================

    /**
     * Mengambil semua skor dan mengagregasi total skor untuk setiap wallet (akumulatif).
     * @returns {Array<Object>} Array objek yang berisi { walletAddress, displayName, totalScore }.
     */
    async function getGlobalLeaderboard() {
        globalStatusEl.textContent = "Mengambil semua entri skor dari Database...";
        let allScores = [];
        
        if (!db || !appId) {
             globalStatusEl.textContent = "⚠ ERROR! Database tidak terhubung. Tidak dapat memuat skor.";
             globalStatusEl.style.backgroundColor = 'rgba(255, 0, 0, 0.2)';
             return [];
        }

        try {
            const leaderboardRef = collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard');
            const q = query(leaderboardRef); 
            const querySnapshot = await getDocs(q);
            
            querySnapshot.forEach((doc) => {
                allScores.push(doc.data());
            });
            
            globalStatusEl.textContent = "Data skor berhasil diunduh. Menghitung akumulasi berdasarkan Wallet...";

        } catch (e) {
            console.error("Gagal memuat Leaderboard Global:", e);
            globalStatusEl.textContent = "⚠ ERROR! Gagal Memuat data skor dari Firestore.";
            globalStatusEl.style.backgroundColor = 'rgba(255, 0, 0, 0.2)'; 
            return [];
        }
        
        // 1. Agregasi Skor Akumulatif berdasarkan walletAddress
        const aggregatedScores = allScores.reduce((acc, scoreData) => {
            const { walletAddress, displayName, score } = scoreData;
            
            // Hanya agregasi jika walletAddress ada (sesuai permintaan user)
            if (!walletAddress) return acc;
            
            if (!acc[walletAddress]) {
                acc[walletAddress] = {
                    walletAddress: walletAddress,
                    displayName: displayName || 'Anon Wallet',
                    totalScore: 0,
                };
            }
            
            // Akumulasi skor
            acc[walletAddress].totalScore += score;
            return acc;
        }, {});

        // 2. Ubah objek menjadi array dan urutkan
        const finalLeaderboard = Object.values(aggregatedScores);
        finalLeaderboard.sort((a, b) => b.totalScore - a.totalScore); 
        
        globalStatusEl.textContent = `Leaderboard Global Aktif! Total Wallet: ${finalLeaderboard.length}`;

        return finalLeaderboard;
    }

    /**
     * Merender data Leaderboard yang sudah diakumulasi dan diurutkan.
     */
    function renderLeaderboard(leaderboardData) {
        leaderboardBody.innerHTML = ''; 
        
        if (leaderboardData.length === 0) {
            leaderboardBody.innerHTML = `<tr><td colspan="4" style="text-align: center; color: #ff8c00;">Belum ada skor yang tersimpan.</td></tr>`;
            return;
        }

        const topScores = leaderboardData.slice(0, 10); 

        topScores.forEach((playerData, index) => {
            const rank = index + 1;
            const rankClass = rank <= 3 ? `rank-${rank}` : '';

            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="${rankClass}">${rank}</td>
                <td class="${rankClass}">${playerData.displayName}</td>
                <td class="${rankClass}">${playerData.totalScore.toLocaleString()}</td>
                <td class="wallet-cell">${playerData.walletAddress}</td>
            `;
            leaderboardBody.appendChild(row);
        });
    }

    // ====================================================================
    // --- INIT ---
    // ====================================================================

    async function initializeApp() {
        try {
            if (!rawFirebaseConfig || !appId) throw new Error("Config not available.");
            const firebaseConfig = JSON.parse(rawFirebaseConfig);

            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // Autentikasi diperlukan untuk membaca data publik
            if (initialAuthToken) { await signInWithCustomToken(auth, initialAuthToken); } 
            else { await signInAnonymously(auth); }
        } catch (error) {
            console.error("Firebase Init Failed in Leaderboard:", error);
            db = null;
        }
        
        const leaderboardData = await getGlobalLeaderboard();
        renderLeaderboard(leaderboardData);
    }
    
    window.onload = initializeApp;
</script>

</body>
</html>
