<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>üèÜ SOMNIA Leaderboard</title>
  <script src="libs/ethers.min.js"></script>
  <style>
    body {
      background: radial-gradient(circle at top, #7f1d1d, #020617);
      color: white;
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
    }

    h2 {
      color: gold;
      text-shadow: 0 0 10px gold;
      margin-bottom: 10px;
    }

    #status {
      margin: 10px 0;
      color: #facc15;
    }

    table {
      width: 100%;
      margin-top: 15px;
      border-collapse: collapse;
      background: rgba(0,0,0,0.6);
      border-radius: 10px;
      overflow: hidden;
    }

    th, td {
      padding: 10px;
      border-bottom: 1px solid #334155;
    }

    th {
      background: #020617;
      color: #facc15;
    }

    tr:nth-child(even) {
      background: rgba(255,255,255,0.05);
    }
  </style>
</head>
<body>

<h2>üèÜ SOMNIA LEADERBOARD</h2>
<p id="status">‚è≥ Loading blockchain data...</p>

<table id="leaderboardTable" style="display:none">
  <thead>
    <tr>
      <th>#</th>
      <th>Wallet</th>
      <th>Total Score</th>
    </tr>
  </thead>
  <tbody id="leaderboardBody"></tbody>
</table>

<script>
// ================= KONFIG FINAL =================
const CONTRACT_ADDRESS = "0x35a7f3eE9A2b5fdEE717099F9253Ae90e1248AE3";
const CHAIN_ID = 5031;

// ABI leaderboard
// Catatan: ABI ini hanya untuk getTop10(). Jika kontrak punya fungsi getPlayerTotalScore, itu lebih baik.
const CONTRACT_ABI = [
  "function getTop10() view returns (address[] memory, uint256[] memory)"
];
// ===============================================

const statusEl = document.getElementById("status");
const bodyEl   = document.getElementById("leaderboardBody");
const tableEl  = document.getElementById("leaderboardTable");

let provider;

// ‚úÖ PROVIDER SETUP (Tidak Berubah)
if (window.ethereum) {
  provider = new ethers.providers.Web3Provider(window.ethereum);
  console.log("‚úÖ Using Wallet Provider");
} 
else {
  provider = new ethers.providers.JsonRpcProvider(
    "https://api.infra.mainnet.somnia",
    { name: "Somnia Mainnet", chainId: CHAIN_ID }
  );
  console.log("‚ö†Ô∏è Using RPC Fallback");
}

const contract = new ethers.Contract(
  CONTRACT_ADDRESS,
  CONTRACT_ABI,
  provider
);

// ------------------------------------------------------------------
// ‚≠ê FUNGSI BARU: AGREGASI DAN SORTING (INTI PERBAIKAN) ‚≠ê
// ------------------------------------------------------------------
function aggregateAndSort(rawPlayers, rawScores) {
    const aggregated = {};

    // 1. Kumpulkan Total Skor per Wallet (Agregasi)
    for (let i = 0; i < rawPlayers.length; i++) {
        const address = rawPlayers[i];
        // Konversi BigNumber/String menjadi Number
        const score = Number(rawScores[i].toString()); 

        if (aggregated[address]) {
            // Akumulasi: Tambahkan skor ke total yang sudah ada
            aggregated[address] += score;
        } else {
            // Inisialisasi: Buat entri baru
            aggregated[address] = score;
        }
    }

    // 2. Konversi hasil agregasi ke Array
    const finalLeaderboard = Object.keys(aggregated).map(address => ({
        wallet: address,
        totalScore: aggregated[address]
    }));

    // 3. Urutkan Array berdasarkan Total Score (Descending)
    finalLeaderboard.sort((a, b) => b.totalScore - a.totalScore);

    return finalLeaderboard;
}

// ------------------------------------------------------------------
// ‚≠ê FUNGSI BARU: RENDER TABEL ‚≠ê
// ------------------------------------------------------------------
function renderLeaderboardTable(data) {
    bodyEl.innerHTML = ""; // Bersihkan isi tabel

    // Jika data kosong setelah agregasi
    if (data.length === 0) {
        statusEl.innerText = "Tidak ada skor yang tercatat di blockchain saat ini.";
        statusEl.style.display = "block";
        return;
    }

    data.forEach((entry, index) => {
        const rank = index + 1;
        const walletDisplay = entry.wallet.slice(0, 6) + '...' + entry.wallet.slice(-4);

        bodyEl.innerHTML += `
            <tr>
                <td>${rank}</td>
                <td>${walletDisplay}</td>
                <td>${entry.totalScore}</td> 
            </tr>
        `;
    });

    statusEl.style.display = "none";
    tableEl.style.display = "table";
}

// ------------------------------------------------------------------
// ‚≠ê FUNGSI UTAMA: LOAD LEADERBOARD (MEMANGGIL FUNGSI AGREGASI) ‚≠ê
// ------------------------------------------------------------------
async function loadLeaderboard() {
  try {
    // 1. Ambil data mentah (raw data) dari kontrak
    const [rawPlayers, rawScores] = await contract.getTop10();
    
    // 2. Agregasi dan Urutkan data mentah
    const finalData = aggregateAndSort(rawPlayers, rawScores);
    
    // 3. Render data yang sudah bersih ke tabel
    renderLeaderboardTable(finalData);

  } catch (err) {
    console.error("LEADERBOARD ERROR:", err);
    statusEl.innerText = "‚ùå Gagal terhubung ke blockchain leaderboard";
  }
}

// ‚úÖ LOAD SEKALI SAJA
loadLeaderboard();
</script>

</body>
</html>
