<!DOCTYPE html>
<html>
<head>
    <title>Pac-Man Somnia Christmas</title>
    <style>
        body { margin: 0; background: black; display: flex; flex-direction: column; align-items: center; font-family: sans-serif; }
        canvas { border: 2px solid #a00; background: black; }
        .game-container { position: relative; width: 320px; height: 480px; }
        #msgArea {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 20px;
            border: 3px solid #ff5722;
            border-radius: 10px;
            text-align: center;
            font-size: 20px;
            z-index: 10;
            display: none;
            flex-direction: column;
            gap: 15px;
        }
        #actionBtns {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }
        .red {
            background-color: #f44336;
            color: white;
        }
        .green {
            background-color: #4CAF50;
            color: white;
        }
        .red:hover { background-color: #d32f2f; }
        .green:hover { background-color: #388e3c; }
    </style>
</head>
<body>

<div class="game-container">
    <canvas id="pacmanCanvas" width="320" height="480"></canvas>
    
    <div id="msgArea">
        <span id="gameMessage">WELCOME!</span>
        
        <div id="actionBtns" style="display: none;">
            <button id="submitScoreBtn" class="btn red">Submit Score (On-Chain)</button>
            <button id="backBtn" class="btn red">Kembali ke Menu Utama</button>
            <button id="playAgainBtn" class="btn green">Main Lagi (Bayar Ulang)</button>
        </div>
    </div>
</div>

<script>
    // Constants
    const TILE_SIZE = 20;
    const GRID_WIDTH = 16;
    const GRID_HEIGHT = 24;
    
    // Game state
    let map = [
        // Map 16x24 (0=Wall, 1=Path, 2=Dot, 3=Power Pellet)
        // ... (Harusnya ada data map di sini, saya asumsikan sudah ada) ...
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,2,2,2,2,2,2,0,0,2,2,2,2,2,2,0,
        0,2,0,0,0,0,2,0,0,2,0,0,0,0,2,0,
        0,3,0,0,0,0,2,2,2,2,0,0,0,0,3,0,
        0,2,0,0,0,0,2,0,0,2,0,0,0,0,2,0,
        0,2,2,2,2,2,2,0,0,2,2,2,2,2,2,0,
        0,0,0,0,0,0,2,0,0,2,0,0,0,0,0,0,
        0,0,0,0,0,0,2,2,2,2,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
        1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,2,2,2,2,2,2,2,2,2,2,2,2,2,2,0,
        0,2,0,0,0,0,2,0,0,2,0,0,0,0,2,0,
        0,2,0,0,0,0,2,2,2,2,0,0,0,0,2,0,
        0,2,2,2,2,2,2,0,0,2,2,2,2,2,2,0,
        0,0,0,0,0,0,2,0,0,2,0,0,0,0,0,0,
        0,0,0,0,0,0,2,2,2,2,0,0,0,0,0,0,
        0,2,2,2,2,2,2,0,0,2,2,2,2,2,2,0,
        0,2,0,0,0,0,2,0,0,2,0,0,0,0,2,0,
        0,3,0,0,0,0,2,2,2,2,0,0,0,0,3,0,
        0,2,0,0,0,0,2,0,0,2,0,0,0,0,2,0,
        0,2,2,2,2,2,2,0,0,2,2,2,2,2,2,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    ];
    
    // Player State
    let pacmanX = 8 * TILE_SIZE; 
    let pacmanY = 16 * TILE_SIZE; 
    let direction = 'RIGHT'; 
    let nextDirection = 'RIGHT'; 
    let speed = 2; 
    let score = 0;
    let lives = 3;
    let gameRunning = false;
    let ghostFrightened = false;
    
    // Ghost State (Contoh 2 Hantu)
    let ghosts = [
        { x: 7 * TILE_SIZE, y: 10 * TILE_SIZE, color: 'cyan', direction: 'UP' },
        { x: 8 * TILE_SIZE, y: 10 * TILE_SIZE, color: 'pink', direction: 'DOWN' }
    ];

    // References
    const canvas = document.getElementById('pacmanCanvas');
    const ctx = canvas.getContext('2d');
    const msgArea = document.getElementById('msgArea');
    const gm = document.getElementById('gameMessage');
    let actionBtns = document.getElementById('actionBtns'); 
    
    // [Fungsi-fungsi Helper Gambar, Gerak, Tabrakan, dll.]
    
    function getTile(x, y) {
        const col = Math.floor(x / TILE_SIZE);
        const row = Math.floor(y / TILE_SIZE);
        if (col < 0 || col >= GRID_WIDTH || row < 0 || row >= GRID_HEIGHT) return 0;
        return map[row * GRID_WIDTH + col];
    }

    function setTile(x, y, value) {
        const col = Math.floor(x / TILE_SIZE);
        const row = Math.floor(y / TILE_SIZE);
        if (col >= 0 && col < GRID_WIDTH && row >= 0 && row < GRID_HEIGHT) {
            map[row * GRID_WIDTH + col] = value;
        }
    }

    // ... (Fungsi drawMap, drawPacman, drawGhosts, movePacman, checkCollision, dll. Lanjutkan di sini) ...
    
    function drawMap() {
        for (let row = 0; row < GRID_HEIGHT; row++) {
            for (let col = 0; col < GRID_WIDTH; col++) {
                const tileValue = map[row * GRID_WIDTH + col];
                const x = col * TILE_SIZE;
                const y = row * TILE_SIZE;

                if (tileValue === 0) {
                    ctx.fillStyle = 'darkred';
                    ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE);
                    ctx.strokeStyle = '#a00';
                    ctx.strokeRect(x, y, TILE_SIZE, TILE_SIZE);
                } else if (tileValue === 2) {
                    ctx.fillStyle = 'yellow';
                    ctx.beginPath();
                    ctx.arc(x + TILE_SIZE / 2, y + TILE_SIZE / 2, 3, 0, 2 * Math.PI);
                    ctx.fill();
                } else if (tileValue === 3) {
                    ctx.fillStyle = 'white';
                    ctx.beginPath();
                    ctx.arc(x + TILE_SIZE / 2, y + TILE_SIZE / 2, 5, 0, 2 * Math.PI);
                    ctx.fill();
                }
            }
        }
    }

    function drawPacman() {
        ctx.fillStyle = 'yellow';
        ctx.beginPath();
        // Sederhana: Lingkaran penuh
        ctx.arc(pacmanX + TILE_SIZE / 2, pacmanY + TILE_SIZE / 2, TILE_SIZE / 2 - 2, 0, 2 * Math.PI);
        ctx.fill();
    }

    function drawGhosts() {
        ghosts.forEach(ghost => {
            ctx.fillStyle = ghostFrightened ? 'blue' : ghost.color;
            ctx.beginPath();
            // Sederhana: Lingkaran
            ctx.arc(ghost.x + TILE_SIZE / 2, ghost.y + TILE_SIZE / 2, TILE_SIZE / 2 - 2, 0, 2 * Math.PI);
            ctx.fill();
            // Mata (Opsional)
            ctx.fillStyle = 'white';
            ctx.beginPath();
            ctx.arc(ghost.x + TILE_SIZE / 2 - 3, ghost.y + TILE_SIZE / 2 - 3, 2, 0, 2 * Math.PI);
            ctx.arc(ghost.x + TILE_SIZE / 2 + 3, ghost.y + TILE_SIZE / 2 - 3, 2, 0, 2 * Math.PI);
            ctx.fill();
        });
    }
    
    function canMove(x, y, dir) {
        let newX = x;
        let newY = y;
        
        // Memeriksa hanya di posisi tengah TILE berikutnya
        if (dir === 'UP') newY -= speed;
        if (dir === 'DOWN') newY += speed;
        if (dir === 'LEFT') newX -= speed;
        if (dir === 'RIGHT') newX += speed;

        // Posisikan di tengah tile
        const targetX = newX + TILE_SIZE / 2;
        const targetY = newY + TILE_SIZE / 2;

        return getTile(targetX, targetY) !== 0;
    }

    function movePacman() {
        if (canMove(pacmanX, pacmanY, nextDirection)) {
            direction = nextDirection;
        }

        let moved = false;
        if (direction === 'UP' && canMove(pacmanX, pacmanY, 'UP')) {
            pacmanY -= speed; moved = true;
        } else if (direction === 'DOWN' && canMove(pacmanX, pacmanY, 'DOWN')) {
            pacmanY += speed; moved = true;
        } else if (direction === 'LEFT' && canMove(pacmanX, pacmanY, 'LEFT')) {
            pacmanX -= speed; moved = true;
        } else if (direction === 'RIGHT' && canMove(pacmanX, pacmanY, 'RIGHT')) {
            pacmanX += speed; moved = true;
        }

        // Loop di pinggir (jika peta memungkinkan)
        if (pacmanX < -TILE_SIZE) pacmanX = GRID_WIDTH * TILE_SIZE;
        if (pacmanX > GRID_WIDTH * TILE_SIZE) pacmanX = -TILE_SIZE;
        
        return moved;
    }

    function moveGhosts() {
        // Implementasi pergerakan hantu sederhana (random atau berbasis target Pacman)
        ghosts.forEach(ghost => {
            // Logika sederhana: ambil arah acak yang valid
            const possibleDirections = ['UP', 'DOWN', 'LEFT', 'RIGHT'];
            let newDir = ghost.direction;
            let attempts = 0;

            while (!canMove(ghost.x, ghost.y, newDir) && attempts < 4) {
                newDir = possibleDirections[Math.floor(Math.random() * 4)];
                attempts++;
            }
            
            ghost.direction = newDir;

            if (ghost.direction === 'UP' && canMove(ghost.x, ghost.y, 'UP')) ghost.y -= speed;
            else if (ghost.direction === 'DOWN' && canMove(ghost.x, ghost.y, 'DOWN')) ghost.y += speed;
            else if (ghost.direction === 'LEFT' && canMove(ghost.x, ghost.y, 'LEFT')) ghost.x -= speed;
            else if (ghost.direction === 'RIGHT' && canMove(ghost.x, ghost.y, 'RIGHT')) ghost.x += speed;
            
            // Loop di pinggir
            if (ghost.x < -TILE_SIZE) ghost.x = GRID_WIDTH * TILE_SIZE;
            if (ghost.x > GRID_WIDTH * TILE_SIZE) ghost.x = -TILE_SIZE;
        });
    }


    function checkDotCollision() {
        const tileX = pacmanX + TILE_SIZE / 2;
        const tileY = pacmanY + TILE_SIZE / 2;
        
        const tileValue = getTile(tileX, tileY);

        if (tileValue === 2) {
            setTile(tileX, tileY, 1);
            score += 10;
            // Kirim sinyal suara dot dimakan ke parent (app.js)
            parent.postMessage({ type: "dotEaten" }, "*");
        } else if (tileValue === 3) {
            setTile(tileX, tileY, 1);
            score += 50;
            ghostFrightened = true;
            // Matikan mode takut setelah beberapa detik
            setTimeout(() => {
                ghostFrightened = false;
            }, 8000); 
        }
    }

    function checkGhostCollision() {
        const pacmanCenter = { x: pacmanX + TILE_SIZE / 2, y: pacmanY + TILE_SIZE / 2 };
        
        for (let i = 0; i < ghosts.length; i++) {
            const ghost = ghosts[i];
            const ghostCenter = { x: ghost.x + TILE_SIZE / 2, y: ghost.y + TILE_SIZE / 2 };
            
            const dx = pacmanCenter.x - ghostCenter.x;
            const dy = pacmanCenter.y - ghostCenter.y;
            const distance = Math.sqrt(dx * dx + dy * dy);

            if (distance < TILE_SIZE) { 
                if (ghostFrightened) {
                    // Makan Hantu
                    score += 200;
                    ghost.x = 8 * TILE_SIZE; // Kirim kembali ke markas
                    ghost.y = 10 * TILE_SIZE;
                } else {
                    // Game Over atau Kurangi Nyawa
                    lives--;
                    if (lives <= 0) {
                        gameOver();
                    } else {
                        // Reset posisi Pacman dan Hantu
                        pacmanX = 8 * TILE_SIZE; 
                        pacmanY = 16 * TILE_SIZE; 
                        ghosts = [
                            { x: 7 * TILE_SIZE, y: 10 * TILE_SIZE, color: 'cyan', direction: 'UP' },
                            { x: 8 * TILE_SIZE, y: 10 * TILE_SIZE, color: 'pink', direction: 'DOWN' }
                        ];
                    }
                }
                return;
            }
        }
    }

    function checkWinCondition() {
        let dotsLeft = 0;
        for (let i = 0; i < map.length; i++) {
            if (map[i] === 2 || map[i] === 3) {
                dotsLeft++;
            }
        }
        if (dotsLeft === 0) {
            gameWin();
            return true;
        }
        return false;
    }

    // Fungsi Utama Loop
    function gameLoop() {
        if (!gameRunning) return;

        // 1. Update posisi
        movePacman();
        moveGhosts();
        
        // 2. Cek tabrakan/makan
        checkDotCollision();
        checkGhostCollision();
        
        // 3. Cek kondisi menang
        if (checkWinCondition()) return;

        // 4. Gambar ulang
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawMap();
        drawGhosts();
        drawPacman();
        
        // Tampilkan skor di parent (untuk UI top bar)
        parent.postMessage({ type: "updateScore", score, lives }, "*");

        requestAnimationFrame(gameLoop);
    }
    
    // Fungsi untuk Kemenangan
    function gameWin(){
        gameRunning = false;
        finalScore = score;
        gm.textContent = "YOU WIN! Score: " + finalScore;
        
        // ðŸ”¥ KRITIS: TAMPILKAN 3 TOMBOL AKSI, TIDAK ADA DELAY
        msgArea.style.display = "flex"; 
        if (actionBtns) actionBtns.style.display = "block";
        
        const submitBtn = document.getElementById('submitScoreBtn');
        if (submitBtn) {
            submitBtn.textContent = `Submit Score ${finalScore} (On-Chain)`;
            submitBtn.disabled = false; // Pastikan aktif lagi
        }
    }

    // Fungsi Diperbarui untuk Game Over
    function gameOver(){
      gameRunning = false;
      finalScore = score;
      gm.textContent = "GAME OVER! Score: " + finalScore;
      
      // ðŸ”¥ KRITIS: TAMPILKAN 3 TOMBOL AKSI, TIDAK ADA DELAY
      msgArea.style.display = "flex"; 
      if (actionBtns) actionBtns.style.display = "block";
      
      const submitBtn = document.getElementById('submitScoreBtn');
      if (submitBtn) {
          submitBtn.textContent = `Submit Score ${finalScore} (On-Chain)`;
          submitBtn.disabled = false; // Pastikan aktif lagi
      }
    }

    // Fungsi Reset Game untuk Main Lagi
    function resetGame() {
        // Reset Map (Anda perlu fungsi yang memuat ulang map awal)
        // map = originalMapData; 
        
        // Reset State
        pacmanX = 8 * TILE_SIZE; 
        pacmanY = 16 * TILE_SIZE; 
        direction = 'RIGHT'; 
        nextDirection = 'RIGHT'; 
        score = 0;
        lives = 3;
        ghostFrightened = false;
        
        ghosts = [
            { x: 7 * TILE_SIZE, y: 10 * TILE_SIZE, color: 'cyan', direction: 'UP' },
            { x: 8 * TILE_SIZE, y: 10 * TILE_SIZE, color: 'pink', direction: 'DOWN' }
        ];

        // Sembunyikan pesan dan tombol
        msgArea.style.display = "none";
        if (actionBtns) actionBtns.style.display = "none";

        // Tampilkan pesan "READY!"
        gm.textContent = "READY!";
        msgArea.style.display = "flex";

        setTimeout(() => {
            msgArea.style.display = "none";
            gameRunning = true;
            gameLoop();
        }, 3000); 
    }
    
    // Inisialisasi Kontrol D-Pad
    document.addEventListener('DOMContentLoaded', () => {
        // Ambil referensi D-Pad dari parent/index.html jika ada, atau gunakan ini
        const dpads = [
            document.getElementById('dpadUp'),
            document.getElementById('dpadDown'),
            document.getElementById('dpadLeft'),
            document.getElementById('dpadRight')
        ];
        
        // Logika kontrol sentuh/keyboard di sini
        // ...
        
        // Kontrol Keyboard
        document.addEventListener('keydown', (e) => {
            if (!gameRunning) return;
            if (e.key === 'ArrowUp') nextDirection = 'UP';
            else if (e.key === 'ArrowDown') nextDirection = 'DOWN';
            else if (e.key === 'ArrowLeft') nextDirection = 'LEFT';
            else if (e.key === 'ArrowRight') nextDirection = 'RIGHT';
        });

        // ðŸ”¥ KRITIS: Event Listeners untuk 3 Tombol Aksi di Game Over
        
        actionBtns = document.getElementById('actionBtns');
        const submitBtn = document.getElementById('submitScoreBtn');
        const backBtn = document.getElementById('backBtn');
        const playBtn = document.getElementById('playAgainBtn');

        if (submitBtn) {
            submitBtn.addEventListener('click', () => {
                // Kirim score HANYA saat tombol SubmitScore ditekan
                parent.postMessage({ type: "submitScore", score: finalScore }, "*");
                submitBtn.disabled = true; // Nonaktifkan tombol
                submitBtn.textContent = 'Submitting... (Check Wallet)';
            });
        }

        if (backBtn) {
            backBtn.addEventListener('click', () => {
                // Sembunyikan pesan Game Over/Win dan tombol
                msgArea.style.display = "none";
                if (actionBtns) actionBtns.style.display = "none";
                parent.postMessage({ type: "forceShowLogo" }, "*"); // Kirim sinyal kembali ke menu
            });
        }

        if (playBtn) {
            playBtn.addEventListener('click', () => {
                // Sembunyikan pesan Game Over/Win dan tombol
                msgArea.style.display = "none";
                if (actionBtns) actionBtns.style.display = "none";
                
                // Minta izin bayar ulang ke app.js
                parent.postMessage({ type: "requestStartGame" }, "*"); 
                
                // TIDAK resetGame() di sini. resetGame() akan dipanggil oleh app.js setelah transaksi sukses
                // Anda bisa tambahkan pesan tunggu di sini jika perlu: gm.textContent = "Waiting for payment...";
            });
        }
    });

    // Message Handler dari Parent (app.js)
    window.addEventListener("message", (e) => {
        const d = e.data || {};
        
        // Pemicu dari app.js setelah pembayaran sukses
        if (d.type === "paySuccess") {
            resetGame();
        }
        
        // Pemicu dari app.js untuk update D-Pad state (jika D-Pad ada di parent)
        if (d.type === "dpadControl" && gameRunning) {
             if (d.direction === 'UP') nextDirection = 'UP';
             else if (d.direction === 'DOWN') nextDirection = 'DOWN';
             else if (d.direction === 'LEFT') nextDirection = 'LEFT';
             else if (d.direction === 'RIGHT') nextDirection = 'RIGHT';
        }

        // Jika app.js berhasil memproses submit (opsional)
        // Kita tidak lagi memerlukan scoreTxConfirmed/Failed karena tombol selalu muncul.
        // Namun, jika Anda ingin mengaktifkan kembali tombol Submit setelah gagal TX:
        if (d.type === "scoreTxFailed") {
             const submitBtn = document.getElementById('submitScoreBtn');
             if (submitBtn) {
                 submitBtn.disabled = false;
                 submitBtn.textContent = `Submit Score ${finalScore} (On-Chain)`;
             }
        }
    });
    
    // Mulai inisialisasi tampilan
    drawMap();
    drawGhosts();
    drawPacman();
</script>

</body>
</html>

