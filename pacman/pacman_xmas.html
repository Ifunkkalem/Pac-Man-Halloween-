<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pacman Natal Final</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{margin:0;background:#000;color:white;text-align:center;font-family:Arial}
#ui{position:fixed;top:10px;left:10px;z-index:10}
canvas{background:#000;display:block;margin:auto}
#mobileControls{
  position:fixed;bottom:15px;left:50%;
  transform:translateX(-50%);
  display:flex;gap:12px;z-index:20
}
.ctl-btn{
  width:60px;height:60px;border-radius:50%;
  border:none;background:#22c55e;color:#000;font-size:22px
}
#game-message{
  position:fixed;inset:0;
  display:none;align-items:center;justify-content:center;
  background:rgba(0,0,0,.85);
  font-size:80px;color:gold;z-index:99
}
</style>
</head>
<body>

<div id="ui">Score: <span id="current-score-display">0</span></div>
<div id="game-message"></div>
<canvas id="pacman-canvas"></canvas>

<div id="mobileControls">
  <button class="ctl-btn" data-dir="up">↑</button>
  <button class="ctl-btn" data-dir="left">←</button>
  <button class="ctl-btn" data-dir="down">↓</button>
  <button class="ctl-btn" data-dir="right">→</button>
</div>

<script>
(function(){

const canvas = document.getElementById('pacman-canvas');
const ctx = canvas.getContext('2d');

let TILE_SIZE = 20;

const GAME_MAP = [
[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
[1,2,2,2,2,2,2,2,2,1,1,2,2,2,2,2,2,2,2,1],
[1,2,1,1,1,2,1,1,2,1,1,2,1,1,2,1,1,1,2,1],
[1,2,1,1,1,2,1,1,2,1,1,2,1,1,2,1,1,1,2,1],
[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
[1,2,1,1,1,2,1,2,1,1,1,1,2,1,2,1,1,1,2,1],
[1,2,2,2,2,2,1,2,2,2,2,2,2,1,2,2,2,2,2,1],
[1,1,1,1,1,2,1,1,1,0,0,1,1,1,2,1,1,1,1,1],
[0,0,0,0,1,2,1,0,0,0,0,0,0,1,2,1,0,0,0,0],
[1,1,1,1,1,2,1,0,1,1,1,1,0,1,2,1,1,1,1,1],
[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
[1,2,1,1,1,2,1,1,1,1,1,1,1,1,2,1,1,1,2,1],
[1,2,2,2,1,2,2,2,2,1,1,2,2,2,2,1,2,2,2,1],
[1,1,2,1,1,1,1,1,2,1,1,2,1,1,1,1,1,2,1,1],
[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
[1,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,1],
[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
];

const MAP_WIDTH = GAME_MAP[0].length;
const MAP_HEIGHT = GAME_MAP.length;

let pacman, ghosts, score, mapData;
let gameRunning=true, animationFrameId=null;
let lastTime = 0;
const GAME_UPDATE_INTERVAL = 180;

function resizeCanvas(){
  const scale = Math.min(window.innerWidth/(MAP_WIDTH*TILE_SIZE), window.innerHeight/(MAP_HEIGHT*TILE_SIZE));
  canvas.style.transform = `scale(${scale})`;
  canvas.style.transformOrigin = "top center";
}
window.addEventListener("resize", resizeCanvas);

function resetMapData(){
  mapData = GAME_MAP.map(r=>[...r]);
  pacman = { x:1, y:1, dir:'right', nextDir:'right' };
  ghosts = [
    { x:9,y:9,color:'#cc0000' },
    { x:10,y:9,color:'#16a34a' },
    { x:8,y:9,color:'#2563eb' }
  ];
}

function resetGame(){
  resetMapData();
  score=0;
  document.getElementById("current-score-display").textContent = score;
}

function drawMap(){
  for(let y=0;y<MAP_HEIGHT;y++){
    for(let x=0;x<MAP_WIDTH;x++){
      const t=mapData[y][x];
      if(t===1){
        ctx.fillStyle='#cc0000';
        ctx.fillRect(x*TILE_SIZE,y*TILE_SIZE,TILE_SIZE,TILE_SIZE);
      }else{
        ctx.fillStyle='#1a2c42';
        ctx.fillRect(x*TILE_SIZE,y*TILE_SIZE,TILE_SIZE,TILE_SIZE);
        if(t===2){
          ctx.fillStyle='#facc15';
          ctx.beginPath();
          ctx.arc(x*TILE_SIZE+10,y*TILE_SIZE+10,3,0,Math.PI*2);
          ctx.fill();
        }
      }
    }
  }
}

function drawPacman(){
  ctx.fillStyle="#facc15";
  ctx.beginPath();
  ctx.arc(pacman.x*TILE_SIZE+10,pacman.y*TILE_SIZE+10,7,0,Math.PI*2);
  ctx.fill();
}

function drawGhosts(){
  ghosts.forEach(g=>{
    ctx.fillStyle=g.color;
    ctx.beginPath();
    ctx.arc(g.x*TILE_SIZE+10,g.y*TILE_SIZE+10,9,0,Math.PI*2);
    ctx.fill();
  });
}

function canMove(x,y){
  return mapData[y] && mapData[y][x]!==1;
}

function movePacman(){
  const d=pacman.nextDir;
  const dx={left:-1,right:1,up:0,down:0}[d];
  const dy={up:-1,down:1,left:0,right:0}[d];

  if(canMove(pacman.x+dx,pacman.y+dy))
    pacman.dir=d;

  const mx={left:-1,right:1,up:0,down:0}[pacman.dir];
  const my={up:-1,down:1,left:0,right:0}[pacman.dir];

  if(canMove(pacman.x+mx,pacman.y+my)){
    pacman.x+=mx;
    pacman.y+=my;
  }

  if(mapData[pacman.y][pacman.x]===2){
    mapData[pacman.y][pacman.x]=0;
    score+=10;
    document.getElementById("current-score-display").textContent=score;
  }
}

function moveGhosts(){
  ghosts.forEach(g=>{
    const d=['up','down','left','right'][Math.floor(Math.random()*4)];
    const dx={left:-1,right:1,up:0,down:0}[d];
    const dy={up:-1,down:1,left:0,right:0}[d];
    if(canMove(g.x+dx,g.y+dy)){
      g.x+=dx;
      g.y+=dy;
    }
    if(g.x===pacman.x && g.y===pacman.y) endGame();
  });
}

function gameLoop(time){
  if(time-lastTime>GAME_UPDATE_INTERVAL){
    movePacman();
    moveGhosts();
    lastTime=time;
  }

  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawMap();
  drawPacman();
  drawGhosts();

  animationFrameId=requestAnimationFrame(gameLoop);
}

function endGame(){
  gameRunning=false;
  window.parent.postMessage({type:"submitScore",score:score},"*");
}

document.querySelectorAll(".ctl-btn").forEach(b=>{
  b.onclick=()=>pacman.nextDir=b.dataset.dir;
});

window.onkeydown=e=>{
  if(e.key==="ArrowUp") pacman.nextDir="up";
  if(e.key==="ArrowDown") pacman.nextDir="down";
  if(e.key==="ArrowLeft") pacman.nextDir="left";
  if(e.key==="ArrowRight") pacman.nextDir="right";
};

window.addEventListener("message",(e)=>{
  if(e.data.type==="paySuccess"){
    resetGame();
    gameRunning=true;
  }
});

canvas.width=MAP_WIDTH*TILE_SIZE;
canvas.height=MAP_HEIGHT*TILE_SIZE;
resizeCanvas();
resetGame();
requestAnimationFrame(gameLoop);

})();
</script>
</body>
</html>
